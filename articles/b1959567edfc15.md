---
title: "Twist.nix で再現性のある Emacs 設定を作る"
emoji: "🐙"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["emacs", "nix", "twist.nix"]
published: false
---

## はじめに

Nix を知って 1 年ほど経ち、dotfiles はほぼ全て Nix に寄せましたが、唯一 .emacs.d は手動で clone して管理していました。

設定ファイルは [takeokunn](https://github.com/takeokunn) の構成を真似て作っており、俺は彼と同様に高速で起動する Emacs を使っています。しかし、彼は .emacs.d を Nix の設定に統合し、Nix のもたらす再現性を手にした代わりに高速起動する Emacs を失ってしまいました。（悪口みたいになってごめん）

俺は起動速度と再現性を両立したいんだよ、ということで小難しそうなことで有名な [Twist.nix](https://github.com/emacs-twist/twist.nix) を Emacs の設定に導入することを検討します。

この際、ドキュメント・Example のリポジトリが 2 年ほど前から更新されておらず、Document as code の状態になっていたため、設定に苦労しました。

これについての知見を共有します:

:::message alert
この記事は Twist.nix の Commit hash が **cb0299ed2d7936357288b77d1f22ddbd9e35808d** のときに作成された記事であり、それ以降の Commit での動作を保証するものではありません。
:::

## 実際の設定

俺の設定は以下のリポジトリにあります。

https://github.com/Kyure-A/.emacs.d

## Twist.nix について
Twist.nix は Nix based な Emacs 向けのパッケージマネージャです。Emacs Lisp で書かれたものでいうと、

- package.el
- elpaca
- straight
- quelpa

が担っている部分を Nix が管理してくれるという認識です。Twist.nix を利用することで、Emacs Lisp パッケージのバージョンをユーザーが管理できる上、Nix がパッケージをビルドしていることが保証されるため、パッケージがインストールされているかのチェックが不要になる（してもいいが、パッケージが入っていることは保証されるのでしても意味がないという意）ことで Emacs の起動の高速化が見込めます。

設定ファイルにはもちろん Emacs Lisp を用いることもできますし、Org-babel の Nix 実装が Twist.nix のエコシステムには存在する為、Org-mode で記述したものを利用することもできます。

また、Twist.nix は `use-package` をパースしてくれるため、`use-package` を用いて init.el の設定をしている場合は容易に設定を移行することが可能です。

## ディレクトリ構成
最小構成は以下のようになります:
```
.
└── .emacs.d/
    ├── recipes/
    │   ├── package-recipe1
    │   └── package-recipe2
    ├── lock/
    │   ├── archive.lock
    │   ├── flake.lock
    │   └── flake.nix
    ├── nix/
    │   └── some-lib.nix
    ├── flake.lock
    ├── flake.nix
    └── init.org
```

また、ディレクトリについての説明です:

- `recipes/`
  Emacs Lisp パッケージの recipe が入ります。これは[ MELPA のレシピフォーマット](https://github.com/melpa/melpa?tab=readme-ov-file#recipe-format)で記述でき、quelpa や自身の ELPA を作成して利用している場合は recipe の流用が容易です。
- `lock/`
  Twist.nix が自動生成するロックファイルが配置される場所です。
- `nix/`
  flake.nix から参照される任意の .nix ファイルが配置される場所です。flake.nix が肥大化するのを恐れないのであれば、切り出す必要はないためこのディレクトリは不要です。

これらのディレクトリ構成は [akirak/emacs-config](https://github.com/akirak/emacs-config) と [terlar/emacs-config](https://github.com/terlar/emacs-config) を参考にしていて、この方々は Contributor (というか Author もいる) であるため確度は高いと思われます。

## 知見たち
実際に設定してみて得た Twist.nix の知見と、これを利用する home-manager 側の知見について以下に列挙していきます:

### Twist.nix
#### ロックファイルの生成のやり方がわからない
再現可能な設定をするために Nix を導入したにも関わらず、Twist.nix を用いた Emacs Lisp のバージョン固定用のロックファイル (`archive.lock`, `flake.lock`, `flake.nix`) を生成する方法がわからず数日困りました。

Twist.nix には `lib.makeEnv` という関数があり、Emacs の設定環境を構築できます。この環境を `flake.nix` の outputs における `apps` 属性にセットする際に以下のようにします。(`package` を `lib.makeEnv` で構築した環境とします)

``` nix
 apps = package.makeApps { lockDirName = "lock"; };
```

このとき、`lockDirName` には path ではなく、string を指定してください。

その後 `nix flake show` すると以下のようなレコードが表示されるでしょう。

```
├───apps
│   ├───aarch64-darwin
│   │   ├───lock: app: no description
│   │   └───update: app: no description
│   ├───aarch64-linux
│   │   ├───lock: app: no description
│   │   └───update: app: no description
│   ├───x86_64-darwin
│   │   ├───lock: app: no description
│   │   └───update: app: no description
│   └───x86_64-linux
│       ├───lock: app: no description
│       └───update: app: no description
```

`apps` は flake の標準出力カテゴリの一つである為、コマンドラインにて

```
 nix run .#lock --impure
```

を実行するとロックファイルが `lib.makeEnv` の引数に渡した `lockDir` と同じ path に生成されます。

#### Example に deprecated なものが多い
`inventories` という変数を [examples](https://github.com/emacs-twist/examples) では `lib.makeEnv` の引数に渡していると思うんですが、これは deprecated となっていて、`registries` という引数に渡すべきらしいです。これについてはあんまり理由がわかりません。

また、Overlay API も deprecated になっています。これについては `inputOverrides` を使うことで設定の簡単化を目指したのだと思います。


