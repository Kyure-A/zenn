---
title: "Twist.nix ã§å†ç¾æ€§ã®ã‚ã‚‹ Emacs è¨­å®šã‚’ä½œã‚‹"
emoji: "ğŸ™"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["emacs", "nix", "twist.nix"]
published: false
---

## ã¯ã˜ã‚ã«

Nix ã‚’çŸ¥ã£ã¦ 1 å¹´ã»ã©çµŒã¡ã€dotfiles ã¯ã»ã¼å…¨ã¦ Nix ã«å¯„ã›ã¾ã—ãŸãŒã€å”¯ä¸€ .emacs.d ã¯æ‰‹å‹•ã§ clone ã—ã¦ç®¡ç†ã—ã¦ã„ã¾ã—ãŸã€‚

è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã¯ [takeokunn](https://github.com/takeokunn) ã®æ§‹æˆã‚’çœŸä¼¼ã¦ä½œã£ã¦ãŠã‚Šã€ä¿ºã¯å½¼ã¨åŒæ§˜ã«é«˜é€Ÿã§èµ·å‹•ã™ã‚‹ Emacs ã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚ã—ã‹ã—ã€å½¼ã¯ .emacs.d ã‚’ Nix ã®è¨­å®šã«çµ±åˆã—ã€Nix ã®ã‚‚ãŸã‚‰ã™å†ç¾æ€§ã‚’æ‰‹ã«ã—ãŸä»£ã‚ã‚Šã«é«˜é€Ÿèµ·å‹•ã™ã‚‹ Emacs ã‚’å¤±ã£ã¦ã—ã¾ã„ã¾ã—ãŸã€‚ï¼ˆæ‚ªå£ã¿ãŸã„ã«ãªã£ã¦ã”ã‚ã‚“ï¼‰

ä¿ºã¯èµ·å‹•é€Ÿåº¦ã¨å†ç¾æ€§ã‚’ä¸¡ç«‹ã—ãŸã„ã‚“ã ã‚ˆã€ã¨ã„ã†ã“ã¨ã§å°é›£ã—ãã†ãªã“ã¨ã§æœ‰åãª [Twist.nix](https://github.com/emacs-twist/twist.nix) ã‚’ Emacs ã®è¨­å®šã«å°å…¥ã™ã‚‹ã“ã¨ã‚’æ¤œè¨ã—ã¾ã™ã€‚

ã“ã®éš›ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ»Example ã®ãƒªãƒã‚¸ãƒˆãƒªãŒ 2 å¹´ã»ã©å‰ã‹ã‚‰æ›´æ–°ã•ã‚Œã¦ãŠã‚‰ãšã€Document as code ã®çŠ¶æ…‹ã«ãªã£ã¦ã„ãŸãŸã‚ã€è¨­å®šã«è‹¦åŠ´ã—ã¾ã—ãŸã€‚

ã“ã‚Œã«ã¤ã„ã¦ã®çŸ¥è¦‹ã‚’å…±æœ‰ã—ã¾ã™:

:::message alert
ã“ã®è¨˜äº‹ã¯ Twist.nix ã® Commit hash ãŒ **cb0299ed2d7936357288b77d1f22ddbd9e35808d** ã®ã¨ãã«ä½œæˆã•ã‚ŒãŸè¨˜äº‹ã§ã‚ã‚Šã€ãã‚Œä»¥é™ã® Commit ã§ã®å‹•ä½œã‚’ä¿è¨¼ã™ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
:::

## å®Ÿéš›ã®è¨­å®š

ä¿ºã®è¨­å®šã¯ä»¥ä¸‹ã®ãƒªãƒã‚¸ãƒˆãƒªã«ã‚ã‚Šã¾ã™ã€‚å‹•ã‹ãªã„æ™‚ã¯ã“ã‚Œã‚’ã¿ã¦ãã ã•ã„

https://github.com/Kyure-A/.emacs.d

## Twist.nix ã«ã¤ã„ã¦
Twist.nix ã¯ Nix based ãª Emacs å‘ã‘ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ã§ã™ã€‚Emacs Lisp ã§æ›¸ã‹ã‚ŒãŸã‚‚ã®ã§ã„ã†ã¨ã€

- package.el
- elpaca
- straight
- quelpa

ãŒæ‹…ã£ã¦ã„ã‚‹éƒ¨åˆ†ã‚’ Nix ãŒç®¡ç†ã—ã¦ãã‚Œã‚‹ã¨ã„ã†èªè­˜ã§ã™ã€‚

Twist.nix ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ã€
- Emacs Lisp ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ Commit å˜ä½ã§å›ºå®šã§ãã‚‹
- Nix ãŒãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ã—ã¦ã„ã‚‹ã“ã¨ãŒä¿è¨¼ã•ã‚Œã‚‹ãŸã‚ã€ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã‹ã®ãƒã‚§ãƒƒã‚¯ãŒä¸è¦ã«ãªã‚‹
  - ã‚„ã£ã¦ã‚‚ã„ã„ã‘ã©ã‚„ã‚‹ã ã‘èµ·å‹•æ™‚é–“ãŒé…ããªã‚‹ã ã‘
  - `use-package` ã®å ´åˆã¯ `(setopt use-package-ensure-function '(lambda (&rest args) t))` ã¨ã™ã‚‹ã¨ãƒã‚§ãƒƒã‚¯ãŒãªããªã‚Šã¾ã™

ãªã©Emacs ã®èµ·å‹•ã®é«˜é€ŸåŒ–ãŒè¦‹è¾¼ã‚ã¾ã™ã€‚

è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯ã‚‚ã¡ã‚ã‚“ Emacs Lisp ã‚’ç”¨ã„ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã—ã€Org-babel ã® Nix å®Ÿè£…ãŒ Twist.nix ã®ã‚¨ã‚³ã‚·ã‚¹ãƒ†ãƒ ã«ã¯å­˜åœ¨ã™ã‚‹ç‚ºã€Org-mode ã§è¨˜è¿°ã—ãŸã‚‚ã®ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

ã¾ãŸã€Twist.nix ã¯ `use-package` ã‚’ãƒ‘ãƒ¼ã‚¹ã—ã¦ãã‚Œã‚‹ãŸã‚ã€`use-package` ã‚’ç”¨ã„ã¦ init.el ã®è¨­å®šã‚’ã—ã¦ã„ã‚‹å ´åˆã¯å®¹æ˜“ã«è¨­å®šã‚’ç§»è¡Œã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

## ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ
æœ€å°æ§‹æˆã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™:
```
.
â””â”€â”€ .emacs.d/
    â”œâ”€â”€ recipes/
    â”‚   â”œâ”€â”€ package-recipe1
    â”‚   â””â”€â”€ package-recipe2
    â”œâ”€â”€ lock/
    â”‚   â”œâ”€â”€ archive.lock
    â”‚   â”œâ”€â”€ flake.lock
    â”‚   â””â”€â”€ flake.nix
    â”œâ”€â”€ nix/
    â”‚   â””â”€â”€ some-lib.nix
    â”œâ”€â”€ flake.lock
    â”œâ”€â”€ flake.nix
    â””â”€â”€ init.org
```

ã¾ãŸã€ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã¤ã„ã¦ã®èª¬æ˜ã§ã™:

- `recipes/`
  Emacs Lisp ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã® recipe ãŒå…¥ã‚Šã¾ã™ã€‚ã“ã‚Œã¯[ MELPA ã®ãƒ¬ã‚·ãƒ”ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ](https://github.com/melpa/melpa?tab=readme-ov-file#recipe-format)ã§è¨˜è¿°ã§ãã€quelpa ã‚„è‡ªèº«ã® ELPA ã‚’ä½œæˆã—ã¦åˆ©ç”¨ã—ã¦ã„ã‚‹å ´åˆã¯ recipe ã®æµç”¨ãŒå®¹æ˜“ã§ã™ã€‚
- `lock/`
  Twist.nix ãŒè‡ªå‹•ç”Ÿæˆã™ã‚‹ãƒ­ãƒƒã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ãŒé…ç½®ã•ã‚Œã‚‹å ´æ‰€ã§ã™ã€‚
- `nix/`
  flake.nix ã‹ã‚‰å‚ç…§ã•ã‚Œã‚‹ä»»æ„ã® .nix ãƒ•ã‚¡ã‚¤ãƒ«ãŒé…ç½®ã•ã‚Œã‚‹å ´æ‰€ã§ã™ã€‚flake.nix ãŒè‚¥å¤§åŒ–ã™ã‚‹ã®ã‚’æã‚Œãªã„ã®ã§ã‚ã‚Œã°ã€åˆ‡ã‚Šå‡ºã™å¿…è¦ã¯ãªã„ãŸã‚ã“ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯ä¸è¦ã§ã™ã€‚

ã“ã‚Œã‚‰ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã¯ [akirak/emacs-config](https://github.com/akirak/emacs-config) ã¨ [terlar/emacs-config](https://github.com/terlar/emacs-config) ã‚’å‚è€ƒã«ã—ã¦ã„ã¦ã€ã“ã®æ–¹ã€…ã¯ Contributor (ã¨ã„ã†ã‹ Author ã‚‚ã„ã‚‹) ã§ã‚ã‚‹ãŸã‚ç¢ºåº¦ã¯é«˜ã„ã¨æ€ã‚ã‚Œã¾ã™ã€‚

## .emacs.d/flake.nix ã®æ§‹æˆ

### flake.nix

``` nix
{
  inputs = {
    flake-utils.url = "github:numtide/flake-utils";
    
    twist.url = "github:emacs-twist/twist.nix";
    
    org-babel.url = "github:emacs-twist/org-babel";

    elpa = {
      url = "github:elpa-mirrors/elpa";
      flake = false;
    };
    
    melpa = {
      url = "github:melpa/melpa";
      flake = false;
    };
    
    nongnu = {
      url = "github:elpa-mirrors/nongnu";
      flake = false;
    };
    
    epkgs = {
      url = "github:emacsmirror/epkgs";
      flake = false;
    };

    emacs-overlay.url = "github:nix-community/emacs-overlay";
  };

  outputs = {
    self,
      nixpkgs,
      flake-utils,
      emacs,
      ...
  } @ inputs: flake-utils.lib.eachDefaultSystem
        (system: let
          inherit (nixpkgs) lib;
          
          pkgs = import nixpkgs {
            inherit system;
            overlays = [
              inputs.org-babel.overlays.default
              emacs-overlay.overlay
            ];
          };

          profile = {
            lockDir = ./lock;
            initFiles = [ (pkgs.tangleOrgBabelFile "init.el" ./init.org {}) ]
            emacsPackage = pkgs.emacs-git;
            extraRecipeDir = ./recipes;
          };

          package = (inputs.twist.lib.makeEnv {
            inherit pkgs;
            inherit (profile) emacsPackage lockDir initFiles;
            registries = (import ./nix/registries.nix inputs) ++ [
              {
                name = "custom";
                type = "melpa";
                path = profile.extraRecipeDir;
              }
            ];
          });
          
        in {
          packages.default = package;

          homeModules.twist = {
            imports = [
              inputs.twist.homeModules.emacs-twist
            ];
          };
          
          apps = package.makeApps {
            lockDirName = "lock";
          };
        });
}
```

`inputs` ã«ã¯ ELPA ã‚„ MELPA ãªã©ã®é flake ã®ãƒªãƒã‚¸ãƒˆãƒªãŒã‚ã‚Šã¾ã™ãŒã€attribute ã« `flake = false;` ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§ç®¡ç†ã§ãã¾ã™ã€‚

`outputs.profile` ã§ã¯ Emacs ã®è¨­å®šã«ã¤ã„ã¦è¨˜è¿°ã•ã‚Œã¦ãŠã‚Šã€
- `lockDir`: ãƒ­ãƒƒã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã™ã‚‹ä½ç½®
- `initFiles`: init.el, early-init.el ãªã©ã‚’ã¯ã˜ã‚ã¨ã™ã‚‹è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
- `emacsPackage`: Twist.nix ã§ç”Ÿæˆã™ã‚‹ç’°å¢ƒã§ä½¿ã† Emacs ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ (Stable ã«ã™ã‚‹ã‹ HEAD Build ã‚’ä½¿ã†ã‹ã¿ãŸã„ãªæŒ‡å®š)

### registries.nix
registries.nix ã¯ãã®åã®ã¨ãŠã‚Šã§ã€ELPA ã‚„ MELPA ãªã©ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã«ã¤ã„ã¦è¨˜è¿°ã—ã¦ã„ã¾ã™: 

``` nix
inputs: [
  {
    name = "gnu";
    type = "elpa";
    path = inputs.elpa.outPath + "/elpa-packages";
    auto-sync-only = true;
    exclude = [
      "lv"
    ];
  }
  {
    name = "melpa";
    type = "melpa";
    path = inputs.melpa.outPath + "/recipes";
  }
  {
    type = "elpa";
    path = inputs.nongnu.outPath + "/elpa-packages";
  }
  {
    name = "gnu-devel";
    type = "archive";
    url = "https://elpa.gnu.org/devel/";
  }
  {
    name = "nongnu-devel";
    type = "archive";
    url = "https://elpa.nongnu.org/nongnu-devel/";
  }
  {
    name = "emacsmirror";
    type = "gitmodules";
    path = inputs.epkgs.outPath + "/.gitmodules";
  }
]

```

æœ€å°æ§‹æˆã¯æ„å¤–ã¨ã‚·ãƒ³ãƒ—ãƒ«ã§ã‚ã‚Šã€æ—¢å­˜ã®è¨­å®šã«ã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«åˆ†ã‘ãŒé›£è§£ã•ã‚’æ¼”å‡ºã—ã¦ã„ãŸã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

## home-manager ã®è¨­å®š
### programs.emacs-twist
`emacs-d` ã¨ã—ã¦ .emacs.d ã®è¨­å®šã‚’ `inputs` ã§èª­ã¿è¾¼ã¿ã€`emacs-config = emacs-d.package.${system}.default` ã¨ã—ã¾ã™

``` nix
{ emacs-config } : {
  programs.emacs-twist = {
    enable = true;
    emacsclient.enable = true;
    createInitFile = true;
    config = emacs-config;
  };
}
```

## çŸ¥è¦‹ãŸã¡
å®Ÿéš›ã«è¨­å®šã—ã¦ã¿ã¦å¾—ãŸ Twist.nix ã®çŸ¥è¦‹ã¨ã€ã“ã‚Œã‚’åˆ©ç”¨ã™ã‚‹ home-manager å´ã®çŸ¥è¦‹ã«ã¤ã„ã¦ä»¥ä¸‹ã«åˆ—æŒ™ã—ã¦ã„ãã¾ã™:

### Twist.nix
#### ãƒ­ãƒƒã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã®ç”Ÿæˆã®ã‚„ã‚Šæ–¹ãŒã‚ã‹ã‚‰ãªã„
å†ç¾å¯èƒ½ãªè¨­å®šã‚’ã™ã‚‹ãŸã‚ã« Nix ã‚’å°å…¥ã—ãŸã«ã‚‚é–¢ã‚ã‚‰ãšã€Twist.nix ã‚’ç”¨ã„ãŸ Emacs Lisp ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³å›ºå®šç”¨ã®ãƒ­ãƒƒã‚¯ãƒ•ã‚¡ã‚¤ãƒ« (`archive.lock`, `flake.lock`, `flake.nix`) ã‚’ç”Ÿæˆã™ã‚‹æ–¹æ³•ãŒã‚ã‹ã‚‰ãšæ•°æ—¥å›°ã‚Šã¾ã—ãŸã€‚

ä¸Šã® flake.nix ã®æ§‹æˆã§æ›¸ã„ãŸé€šã‚Šã€Twist.nix ã«ã¯ `lib.makeEnv` ã¨ã„ã†é–¢æ•°ãŒã‚ã‚Šã€Emacs ã®è¨­å®šç’°å¢ƒã‚’æ§‹ç¯‰ã§ãã¾ã™ã€‚ã“ã®ç’°å¢ƒã‚’ `flake.nix` ã® outputs ã«ãŠã‘ã‚‹ `apps` å±æ€§ã«ã‚»ãƒƒãƒˆã™ã‚‹éš›ã«ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¾ã™ã€‚(`package` ã‚’ `lib.makeEnv` ã§æ§‹ç¯‰ã—ãŸç’°å¢ƒã¨ã—ã¾ã™)

``` nix
 apps = package.makeApps { lockDirName = "lock"; };
```

ã“ã®ã¨ãã€`lockDirName` ã«ã¯ path ã§ã¯ãªãã€string ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚

ãã®å¾Œ `nix flake show` ã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ¬ã‚³ãƒ¼ãƒ‰ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã§ã—ã‚‡ã†:

```
â”œâ”€â”€â”€apps
â”‚   â”œâ”€â”€â”€aarch64-darwin
â”‚   â”‚   â”œâ”€â”€â”€lock: app: no description
â”‚   â”‚   â””â”€â”€â”€update: app: no description
â”‚   â”œâ”€â”€â”€aarch64-linux
â”‚   â”‚   â”œâ”€â”€â”€lock: app: no description
â”‚   â”‚   â””â”€â”€â”€update: app: no description
â”‚   â”œâ”€â”€â”€x86_64-darwin
â”‚   â”‚   â”œâ”€â”€â”€lock: app: no description
â”‚   â”‚   â””â”€â”€â”€update: app: no description
â”‚   â””â”€â”€â”€x86_64-linux
â”‚       â”œâ”€â”€â”€lock: app: no description
â”‚       â””â”€â”€â”€update: app: no description
```

`apps` ã¯ flake ã®æ¨™æº–å‡ºåŠ›ã‚«ãƒ†ã‚´ãƒªã®ä¸€ã¤ã§ã‚ã‚‹ç‚ºã€ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã«ã¦

```
 nix run .#lock --impure
```

ã‚’å®Ÿè¡Œã™ã‚‹ã¨ãƒ­ãƒƒã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ãŒ `lib.makeEnv` ã®å¼•æ•°ã«æ¸¡ã—ãŸ `lockDir` ã¨åŒã˜ path ã«ç”Ÿæˆã•ã‚Œã¾ã™ã€‚

#### Example ã« deprecated ãªã‚‚ã®ãŒå¤šã„
`inventories` ã¨ã„ã†å¤‰æ•°ã‚’ [examples](https://github.com/emacs-twist/examples) ã§ã¯ `lib.makeEnv` ã®å¼•æ•°ã«æ¸¡ã—ã¦ã„ã‚‹ã¨æ€ã†ã‚“ã§ã™ãŒã€ã“ã‚Œã¯ deprecated ã¨ãªã£ã¦ã„ã¦ã€`registries` ã¨ã„ã†å¼•æ•°ã«æ¸¡ã™ã¹ãã‚‰ã—ã„ã§ã™ã€‚ã“ã‚Œã«ã¤ã„ã¦ã¯ã‚ã‚“ã¾ã‚Šç†ç”±ãŒã‚ã‹ã‚Šã¾ã›ã‚“ã€‚

ã¾ãŸã€Overlay API ã‚‚ deprecated ã«ãªã£ã¦ã„ã¾ã™ã€‚ã“ã‚Œã«ã¤ã„ã¦ã¯ `inputOverrides` ã‚’ä½¿ã†ã“ã¨ã§è¨­å®šã®ç°¡å˜åŒ–ã‚’ç›®æŒ‡ã—ãŸã®ã ã¨æ€ã„ã¾ã™ã€‚


